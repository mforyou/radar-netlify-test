<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <title>ArkoRadar 3000 ULTRA</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{
      --bg:#0c0f12; --panel:#131922; --txt:#d7e4f7; --muted:#8aa0b8;
      --accent:#00ff66; --warn:#ff5757; --link:#4aa3ff; --line:#223044;
    }
    html,body{height:100%}
    body{margin:0;background:radial-gradient(1200px 700px at 60% 30%, #101722, #0b1016 65%, #080b10);
         color:var(--txt); font:16px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif}
    .wrap{max-width:1100px; margin:28px auto; padding:0 16px}
    h1{margin:0 0 6px; font-size:34px; letter-spacing:.5px; color:var(--accent)}
    .status{margin:4px 0 18px; font-size:14px; color:var(--muted)}
    .status .err{color:var(--warn); font-weight:600}
    .bar{display:flex; gap:10px; align-items:center; margin:0 0 8px}
    .btn{background:#1b2533; color:#e8f1ff; border:1px solid #2a3a52; padding:8px 12px; border-radius:8px;
         cursor:pointer; font-weight:600}
    .btn:hover{filter:brightness(1.1)}
    .pill{color:#b6c9df; font-size:12px; border:1px solid #30435c; padding:4px 8px; border-radius:999px}
    table{width:100%; border-collapse:collapse; background:var(--panel); border:1px solid var(--line);
          border-radius:12px; overflow:hidden}
    th,td{padding:12px 14px; border-bottom:1px solid var(--line)}
    th{color:#9ec3ff; font-weight:700; text-align:left; letter-spacing:.3px; background:#121922}
    tbody tr:last-child td{border-bottom:none}
    .right{text-align:right}
    .empty{padding:18px 14px; color:#8aa0b8}
    a{color:var(--link); text-decoration:none}
    footer{margin-top:14px; color:#6c829b; font-size:12px}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>ArkoRadar 3000 ULTRA</h1>

    <div class="bar">
      <button id="refresh" class="btn">üîÑ Od≈õwie≈º</button>
      <span class="pill">Widok: <b>dzisiaj</b> ‚Ä¢ sort: <b>Prob ‚Üì</b></span>
    </div>

    <div id="status" class="status">≈Åadowanie‚Ä¶</div>

    <table>
      <thead>
        <tr>
          <th>Data</th>
          <th>League</th>
          <th>Home</th>
          <th>Away</th>
          <th>Typ</th>
          <th class="right">Prob</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody id="tbody">
        <tr><td colspan="7" class="empty">Brak danych‚Ä¶</td></tr>
      </tbody>
    </table>

    <footer>¬© ArkoRadar</footer>
  </div>

  <script>
    // ‚úÖ Tw√≥j dzia≈ÇajƒÖcy URL Apps Script (WEB APP)
/* eslint-disable */
    const API_URL = "https://script.google.com/macros/s/AKfycbwRqhKR8F6w6JrRuGijUZ7LCLfwTalqJJemRH1_OSa8kvfI3I7lQ5YyA0YFXLA4wQ8Ttg/exec";
/* eslint-enable */

    // -- narzƒôdzia daty --
    const todayRange = () => {
      const now = new Date();
      const y = now.getFullYear(), m = now.getMonth(), d = now.getDate();
      const start = new Date(y, m, d, 0,0,0,0);
      const end   = new Date(y, m, d, 23,59,59,999);
      return [start.getTime(), end.getTime()];
    };

    function parseWhen(v){
      // ISO lub Date albo skr√≥t ‚Äû2025-0905‚Äù
      if (v instanceof Date) return v.getTime();
      if (typeof v === 'number') return v;
      const s = String(v || '').trim();
      // 2025-0905 -> 2025-09-05
      const m = s.match(/^(\d{4})-?(\d{2})-?(\d{2})$/);
      if (m) return new Date(`${m[1]}-${m[2]}-${m[3]}T00:00:00Z`).getTime();
      const t = Date.parse(s);
      return isNaN(t) ? NaN : t;
    }

    const fmtDate = (v) => {
      const t = parseWhen(v);
      if (isNaN(t)) return String(v ?? '');
      return new Date(t).toLocaleString('pl-PL', { hour12:false });
    };
    const fmtProb = (p) => {
      if (p == null || p === '') return '';
      const num = typeof p === 'number' ? p : parseFloat(String(p).replace(',', '.'));
      if (!isFinite(num)) return '';
      // je≈õli w danych 0.82 to 82%, je≈õli 82 to 82%
      const val = num <= 1 ? num * 100 : num;
      return `${Math.round(val)}%`;
    };

    // -- render --
    function renderTable(rows){
      const tb = document.getElementById('tbody');
      if (!rows.length){
        tb.innerHTML = `<tr><td colspan="7" class="empty">Brak danych‚Ä¶</td></tr>`;
        return;
      }
      tb.innerHTML = rows.map(r => `
        <tr>
          <td>${fmtDate(r.date)}</td>
          <td>${r.league ?? ''}</td>
          <td>${r.home ?? ''}</td>
          <td>${r.away ?? ''}</td>
          <td>${r.typ ?? ''}</td>
          <td class="right">${fmtProb(r.prob)}</td>
          <td>${fmtDate(r.status)}</td>
        </tr>
      `).join('');
    }

    // -- g≈Ç√≥wne ≈Çadowanie z filtrami (DZISIAJ + sort Prob ‚Üì) --
    async function loadData(){
      const status = document.getElementById('status');
      try{
        status.textContent = '≈Åadowanie‚Ä¶';
        const url = API_URL + (API_URL.includes('?') ? '&' : '?') + '_=' + Date.now();
        const res = await fetch(url, { cache:'no-store', headers:{ 'cache-control':'no-cache' }});
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const raw = await res.json();

        // Sanitizacja p√≥l + filtr ‚ÄûDZISIAJ‚Äù
        const [start, end] = todayRange();
        const normalized = (raw || []).map(x => ({
          date:   x.date,
          league: x.league,
          home:   x.home,
          away:   x.away,
          typ:    x.typ,
          prob:   x.prob,
          status: x.status ?? x.updated ?? x.lastupdate ?? x.data
        })).filter(r => {
          const t = parseWhen(r.date);
          return !isNaN(t) && t >= start && t <= end;
        });

        // sort po Prob malejƒÖco
        normalized.sort((a,b) => {
          const pa = parseFloat(String(a.prob ?? '').toString().replace(',', '.'));
          const pb = parseFloat(String(b.prob ?? '').toString().replace(',', '.'));
          const va = isFinite(pa) ? (pa <= 1 ? pa*100 : pa) : -1;
          const vb = isFinite(pb) ? (pb <= 1 ? pb*100 : pb) : -1;
          return vb - va;
        });

        renderTable(normalized);
        status.textContent = 'OK  ‚Ä¢  Ostatnia aktualizacja: ' + new Date().toLocaleString('pl-PL', { hour12:false });
      }catch(err){
        console.error(err);
        status.innerHTML = `<span class="err">B≈ÇƒÖd pobierania danych: ${err.message}</span>`;
      }
    }

    // auto-refresh co 5 minut + przycisk
    document.getElementById('refresh').addEventListener('click', loadData);
    loadData();
    setInterval(loadData, 5*60*1000);
  </script>
</body>
</html>
